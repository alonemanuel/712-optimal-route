# PRD v0 — 712 Optimal Route

**Version:** v0
**Created:** 2026-02-20

## Problem

Bus 712 runs from Tel Aviv to Modi'in. The current route's Tel Aviv stops don't reflect where riders actually live — people walk far to reach a stop, or the bus detours through low-demand areas.

There's no data-driven way to propose a better route. The goal is to collect rider address data, compute an optimal set of Tel Aviv stops, and present the result to the Modi'in mayor as a proposal to change the route.

## Goals

1. **Collect rider data** — Replace/supplement the existing Google Form with an integrated submission form (Google auth, one submission per person)
2. **Compute optimal route** — Given submitted addresses, find 5–15 stops in Tel Aviv that minimize the average walking distance for riders, without chasing outliers
3. **Visualize the route** — Show the proposed route on an interactive Google Map, updated live as submissions come in
4. **Support the pitch** — Provide a stats page with key metrics (avg walk distance, coverage %, submission count) for the mayor presentation
5. **Keep it free** — Entire stack runs on free tiers

## Non-Goals

- Optimizing the Modi'in portion of the route (fixed)
- Optimizing the highway segment (fixed)
- Real-time bus tracking or scheduling
- Multi-route or multi-bus support
- Native mobile app (mobile-first web is sufficient)
- Replacing the existing Google Form (it continues to work; the website supplements it)

## Users

| User | Description |
|------|-------------|
| **Rider** | Lives in Tel Aviv, commutes to Modi'in on bus 712. Submits their address and views the proposed route. |
| **Admin (you)** | Reviews submissions, monitors the route, uses stats page for the mayor presentation. |
| **Mayor / decision-maker** | Views the website and stats to evaluate the route proposal. Read-only. |

## Solution

A mobile-first single-page website with two views:

### Main Page — Map + Submit
- Interactive Google Map showing the current proposed route through Tel Aviv
- Route displayed as a polyline with stop markers (5–15 stops)
- "Submit your address" form (Google auth required, one per person)
- When a user submits, the route recalculates (debounced — not on every single submission, batched with a short delay e.g., 30s–1min)
- User can see how far they'd walk to the nearest proposed stop

### Stats Page — For the Presentation
- Total number of submissions
- Average walking distance to nearest stop
- % of riders within 400m of a stop
- Number of stops selected
- Heatmap or density overlay of submitted addresses
- Exportable/shareable (screenshot-friendly layout)

## Requirements

### Functional

| # | Requirement | Priority |
|---|-------------|----------|
| F1 | User can sign in with Google | Must |
| F2 | Authenticated user can submit one Tel Aviv address | Must |
| F3 | Address is geocoded to lat/lng | Must |
| F4 | Optimal route is recalculated on new submissions (debounced) | Must |
| F5 | Route is displayed on Google Maps with stop markers | Must |
| F6 | User can see their walking distance to nearest stop | Should |
| F7 | Stats page shows avg walk distance, coverage %, total submissions | Must |
| F8 | Stats page shows heatmap of demand | Should |
| F9 | Existing Google Sheet data can be imported as seed data | Must |
| F10 | One submission per Google account enforced | Must |
| F11 | Mobile-first responsive design | Must |
| F12 | Starting point in Tel Aviv is flexible (algorithm decides) | Must |
| F13 | Endpoint is fixed (highway on-ramp toward Modi'in) | Must |

### Non-Functional

| # | Requirement |
|---|-------------|
| NF1 | Entire stack on free tiers (hosting, DB, maps API) |
| NF2 | Page loads in <3s on mobile |
| NF3 | Route recalculation completes in <10s for up to 1000 submissions |
| NF4 | Works on modern mobile browsers (Chrome, Safari) |

## Route Optimization — Approach

The algorithm selects 5–15 stops in Tel Aviv that minimize average walking distance:

1. **Cluster** submitted addresses into groups (e.g., k-means or similar)
2. **Select stop locations** at cluster centers, snapped to the nearest road/intersection
3. **Order stops** into a route that starts in a Tel Aviv neighborhood and ends at the highway on-ramp (nearest-neighbor or simple TSP heuristic)
4. **Evaluate** — compute average walking distance and coverage metrics
5. **Choose K** — try different values of K (5–15) and pick the one that balances coverage with route simplicity

The starting point is determined by the algorithm — it's wherever the data density suggests the route should begin.

Outlier addresses (far from any cluster) are noted but don't pull the route toward them.

## Data Model

### Submission
| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique ID |
| google_user_id | string | From Google auth (unique constraint) |
| display_name | string | User's name |
| address_text | string | Raw address as entered |
| lat | float | Geocoded latitude |
| lng | float | Geocoded longitude |
| created_at | datetime | Submission timestamp |

### Computed Route (cached)
| Field | Type | Description |
|-------|------|-------------|
| stops | list of {lat, lng, label} | Ordered stops |
| polyline | encoded string | Route polyline for map display |
| avg_walk_distance_m | float | Average walk distance in meters |
| coverage_400m_pct | float | % of riders within 400m |
| total_submissions | int | Submissions at time of calculation |
| computed_at | datetime | When this route was calculated |

## Data Migration

Seed data from existing Google Sheet:
- Export as CSV
- Map columns to Submission fields (address → geocode → lat/lng)
- Assign placeholder google_user_id (e.g., `seed_<row_number>`)
- Import into DB before launch

## Pages

| Page | Path | Description |
|------|------|-------------|
| Main | `/` | Map with route + submission form |
| Stats | `/stats` | Metrics and heatmap for the presentation |

## Open Questions

1. **Highway on-ramp**: Which specific on-ramp does bus 712 use to leave Tel Aviv? (Needed as the fixed endpoint for the TLV portion)
2. **Google Maps API quota**: Free tier allows ~28,000 map loads/month. Enough for this use case?
3. **Address validation**: Should we restrict submissions to Tel Aviv only, or accept anything and filter later?
4. **Route constraints**: Should the route follow major roads only, or can it use any street?
5. **Existing riders**: How many responses are currently in the Google Sheet?
